#!/Users/fsedanoc/python/subscribe/netconf/bin/python

from ncclient import manager
from ncclient.xml_ import to_ele
from lxml import etree

rpc = """
<establish-subscription xmlns="urn:ietf:params:xml:ns:yang:ietf-event-notifications" xmlns:yp="urn:ietf:params:xml:ns:yang:ietf-yang-push">
    <stream>yp:yang-push</stream>
    <yp:xpath-filter>/wireless-nmsp-oper:nmsp-oper-data/cmx-connection/active</yp:xpath-filter>
    <yp:dampening-period>0</yp:dampening-period>
</establish-subscription>
"""

root = etree.fromstring(rpc)

host = "1.1.1.1"
username = "user"
password = "pass"

if __name__ == '__main__':
    with manager.connect(host=host,
                         port=830,
                         username=username,
                         password=password,
                         timeout=90,
                         hostkey_verify=False) as m:

        response = m.dispatch(to_ele(rpc))
        print("Waiting for notify\n")
        while True:
            n = m.take_notification()
            print(n.notification_xml)
            active = n._root_ele.find('.//{http://cisco.com/ns/yang/Cisco-IOS-XE-wireless-nmsp-oper}active').text
            #peer = n._root_ele.find('.//{http://cisco.com/ns/yang/Cisco-IOS-XE-wireless-nmsp-oper}peer-ip')
            if active == "true":
                #print(f" NMSP connection active is now {active}. Peer is {peer} PText is #{peer.text}")
                print(f"NMSP connection is ACTIVE\n")
            else:
                print(f"NMSP connection is INACTIVE\n")



#<notification xmlns="urn:ietf:params:xml:ns:netconf:notification:1.0"><eventTime>2019-11-19T21:09:50.39Z</eventTime><push-update xmlns="urn:ietf:params:xml:ns:yang:ietf-yang-push"><subscription-id>2147483664</subscription-id><datastore-contents-xml><nmsp-oper-data xmlns="http://cisco.com/ns/yang/Cisco-IOS-XE-wireless-nmsp-oper"><cmx-connection><peer-ip/><connection-id>0</connection-id><active>true</active><con-stats><tx-msg-counter><counter>0</counter><msg-id>0</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>1</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>2</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>3</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>4</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>5</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>6</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>7</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>8</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>9</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>10</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>11</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>12</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>13</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>14</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>15</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>16</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>17</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>18</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>19</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>20</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>21</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>22</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>23</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>24</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>25</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>26</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>27</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>28</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>29</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>30</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>31</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>32</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>33</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>34</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>35</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>36</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>37</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>38</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>39</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>40</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>41</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>42</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>43</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>44</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>45</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>46</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>47</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>48</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>49</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>50</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>51</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>52</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>53</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>54</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>55</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>56</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>57</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>58</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>59</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>60</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>61</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>62</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>63</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>64</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>65</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>66</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>67</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>68</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>69</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>70</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>71</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>72</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>73</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>74</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>75</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>76</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>77</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>78</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>79</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>80</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>81</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>82</msg-id></tx-msg-counter><tx-msg-counter><counter>0</counter><msg-id>83</msg-id></tx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>0</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>1</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>2</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>3</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>4</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>5</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>6</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>7</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>8</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>9</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>10</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>11</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>12</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>13</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>14</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>15</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>16</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>17</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>18</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>19</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>20</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>21</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>22</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>23</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>24</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>25</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>26</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>27</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>28</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>29</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>30</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>31</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>32</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>33</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>34</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>35</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>36</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>37</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>38</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>39</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>40</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>41</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>42</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>43</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>44</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>45</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>46</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>47</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>48</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>49</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>50</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>51</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>52</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>53</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>54</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>55</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>56</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>57</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>58</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>59</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>60</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>61</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>62</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>63</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>64</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>65</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>66</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>67</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>68</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>69</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>70</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>71</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>72</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>73</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>74</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>75</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>76</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>77</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>78</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>79</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>80</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>81</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>82</msg-id></rx-msg-counter><rx-msg-counter><counter>0</counter><msg-id>83</msg-id></rx-msg-counter><unsupported-msg-count>0</unsupported-msg-count><tx-data-frames>0</tx-data-frames><rx-data-frames>0</rx-data-frames><connections>1</connections><disconnections>0</disconnections></con-stats><subscriptions><mask>0</mask></subscriptions><transport>default-class-type2</transport></cmx-connection></nmsp-oper-data></datastore-contents-xml></push-update></notification>